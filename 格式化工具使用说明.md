# bulletproof_formatter.py 使用说明

## 功能特点

这是一个"坚不可摧"的Python代码格式化器，具有以下特点：

- ✅ **无视语法错误**：即使代码有语法错误，也能修复缩进问题
- ✅ **强制修复**：自动将所有制表符（Tab）替换为4个空格
- ✅ **智能缩进**：自动修复所有缩进问题，确保冒号后有正确缩进的代码块
- ✅ **批量处理**：支持单个文件或整个目录的批量修复
- ✅ **自动备份**：修复前自动创建 `.bak` 备份文件
- ✅ **Git集成**：可安装为Git预提交钩子，自动修复

## 使用方法

### 1. 修复单个文件

```bash
# 修复单个Python文件（会自动创建备份）
python bulletproof_formatter.py myfile.py

# 修复单个文件，不创建备份
python bulletproof_formatter.py myfile.py --no-backup
```

### 2. 批量修复目录

```bash
# 修复当前目录下所有Python文件
python bulletproof_formatter.py .

# 修复指定目录
python bulletproof_formatter.py /path/to/project

# 批量修复，不创建备份
python bulletproof_formatter.py . --no-backup
```

### 3. 安装Git预提交钩子

```bash
# 安装后，每次git commit前会自动修复所有Python文件的缩进
python bulletproof_formatter.py --install-hook
```

安装后，每次提交代码前会自动：
1. 修复所有Python文件的缩进问题
2. 将修复后的文件添加到暂存区
3. 然后继续提交流程

## 修复内容

### 1. 缩进统一
- 将所有Tab替换为4个空格
- 统一所有代码块的缩进级别

### 2. 冒号后代码块
- 确保所有 `if/elif/else`、`for/while`、`try/except`、`def`、`class`、`with` 等语句的冒号后都有正确缩进的代码块
- 如果缺少代码块，会自动添加 `pass` 语句

### 3. 特殊关键字处理
- 正确处理 `except`、`elif`、`else`、`finally` 等减少缩进的关键字
- 保持代码结构的正确性

### 4. 注释和空行
- 保持注释的原始格式
- 保留空行

## 示例

### 修复前（有问题的代码）：

```python
def bad_function():
	if condition:  # 使用了Tab
	return None  # 缩进错误
    for item in items:
try:
    process(item)  # 缩进混乱
except:
pass  # 缺少正确缩进
```

### 修复后：

```python
def bad_function():
    if condition:  # Tab已替换为空格
        return None  # 缩进已修复
    for item in items:
        try:
            process(item)  # 缩进已统一
        except:
            pass  # 缩进已修复
```

## 注意事项

1. **备份文件**：默认会创建 `.bak` 备份文件，如果不需要可以加 `--no-backup` 参数
2. **Git钩子**：安装Git钩子后，每次提交都会自动修复，确保代码规范
3. **跳过目录**：自动跳过 `.git`、`__pycache__`、`node_modules`、`venv`、`env` 等目录
4. **编码**：使用UTF-8编码读取和写入文件

## 常见问题

**Q: 修复后代码还能运行吗？**
A: 格式化器只修复缩进和格式问题，不改变代码逻辑。如果原代码有语法错误，修复后仍然会有语法错误，但缩进问题会被修复。

**Q: 会修改代码逻辑吗？**
A: 不会。只修复缩进、Tab替换、冒号后代码块等格式问题，不改变任何代码逻辑。

**Q: 如何撤销修复？**
A: 如果创建了备份文件（`.bak`），可以直接恢复：
```bash
# Windows
copy myfile.py.bak myfile.py

# Linux/macOS
cp myfile.py.bak myfile.py
```

**Q: 可以用于CI/CD吗？**
A: 可以。可以在CI/CD流程中运行此工具，确保代码格式统一。

## 技术细节

- **缩进检测**：基于空格数量计算缩进级别
- **结构识别**：通过冒号和关键字识别代码结构
- **缩进栈**：使用栈结构管理嵌套缩进级别
- **容错处理**：即使遇到语法错误也能继续处理
