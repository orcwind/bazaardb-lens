# 日志管理说明

## 📋 概述

`Bazaar_Lens` 使用自动旋转日志管理系统，可以有效控制日志文件大小，避免占用过多磁盘空间。

## 🔄 自动日志旋转

### 工作原理

程序使用 Python 的 `RotatingFileHandler` 实现日志自动旋转：

- **主日志文件**: `bazaar_helper.log`
- **最大文件大小**: 10 MB
- **备份文件数量**: 3 个
- **总最大空间**: 约 40 MB (1个主文件 + 3个备份)

### 自动旋转规则

1. 当 `bazaar_helper.log` 达到 10 MB 时：
   ```
   bazaar_helper.log       → bazaar_helper.log.1
   bazaar_helper.log.1     → bazaar_helper.log.2
   bazaar_helper.log.2     → bazaar_helper.log.3
   bazaar_helper.log.3     → 被删除
   (创建新的空文件)       → bazaar_helper.log
   ```

2. 始终保持最新的日志在 `bazaar_helper.log` 中
3. 最多保留 3 个历史备份文件
4. 最旧的备份会被自动删除

## 🧹 手动清理日志

### 方法一：通过系统托盘菜单

1. 右键点击系统托盘中的 Bazaar Lens 图标
2. 选择 "清理日志文件 Clean Logs"
3. 查看日志文件列表和总大小
4. 确认清理

**清理效果**：
- 当前日志文件 (`bazaar_helper.log`) 会被**清空**（不删除）
- 所有备份文件会被**删除**
- 程序可以继续正常写入日志

### 方法二：手动删除

直接删除程序目录下的日志文件：
```
bazaar_helper.log
bazaar_helper.log.1
bazaar_helper.log.2
bazaar_helper.log.3
```

**注意**：如果程序正在运行，建议先退出程序再删除日志文件。

## 📊 日志级别

当前日志级别为 `INFO`，记录以下信息：

### INFO 级别（正常信息）
- 程序启动/停止
- 环境检测（开发/打包环境）
- 游戏窗口检测
- 数据加载成功
- 配置更改

### WARNING 级别（警告）
- OCR 识别超时
- 图标加载失败
- 文件未找到

### ERROR 级别（错误）
- OCR 处理异常
- 数据加载失败
- 窗口操作失败
- 系统异常

## 💡 优化建议

### 减少日志记录

如果您不需要详细的调试信息，可以通过以下方式减少日志量：

1. **提高日志级别** - 只记录警告和错误：
   ```python
   logger.setLevel(logging.WARNING)
   ```

2. **增大文件大小限制** - 延长旋转周期：
   ```python
   maxBytes=50*1024*1024  # 改为 50MB
   ```

3. **减少备份数量** - 只保留1-2个备份：
   ```python
   backupCount=1  # 只保留1个备份
   ```

### 查看日志的时机

日志文件主要用于以下场景：

1. **程序出现异常时** - 查看错误详情
2. **功能不正常时** - 检查警告信息
3. **报告问题时** - 提供给开发者诊断

**正常使用时**，无需查看日志文件。

## 📁 日志文件位置

### 开发环境
```
D:\PythonProject\BazaarInfo\bazaardb-desktop\bazaar_helper.log
```

### 安装版本（v1.0.1+）
程序会自动选择合适的日志位置，按优先级：

1. **用户文档目录**（推荐）
   ```
   C:\Users\[用户名]\Documents\Bazaar_Lens\bazaar_helper.log
   ```

2. **临时目录**（备用）
   ```
   C:\Users\[用户名]\AppData\Local\Temp\Bazaar_Lens\bazaar_helper.log
   ```

**为什么改变位置？**
- 避免 `C:\Program Files (x86)\` 权限问题
- 用户文档目录更安全，用户有完全控制权
- 便于用户查找和管理日志文件

## 🔍 查看日志

### Windows 记事本
```
notepad bazaar_helper.log
```

### VS Code
```
code bazaar_helper.log
```

### 命令行查看最后100行
```cmd
powershell -Command "Get-Content bazaar_helper.log -Tail 100"
```

## ⚙️ 技术细节

### RotatingFileHandler 配置

```python
from logging.handlers import RotatingFileHandler

file_handler = RotatingFileHandler(
    'bazaar_helper.log',      # 日志文件名
    maxBytes=10*1024*1024,    # 最大 10MB
    backupCount=3,            # 保留 3 个备份
    encoding='utf-8'          # UTF-8 编码
)
```

### 日志格式

```
%(asctime)s - %(levelname)s - %(message)s
```

示例：
```
2025-10-13 15:30:45,123 - INFO - 检测到打包环境，使用简化OCR策略
2025-10-13 15:30:46,456 - WARNING - OCR识别超时，已跳过本次识别
2025-10-13 15:30:47,789 - ERROR - OCR处理异常: Tesseract not found
```

## 🎯 最佳实践

1. **定期检查日志大小** - 如果日志增长过快，可能有异常
2. **保留最近的备份** - 便于追溯历史问题
3. **出现问题时保存日志** - 在清理前先备份
4. **不要在运行时删除主日志** - 可能导致日志丢失

## 🔄 版本更新

- **v1.0.0**: 基础日志功能
- **v1.0.1**: 添加自动旋转日志系统
- **v1.0.1**: 添加手动清理日志功能

---

如有问题，请查看 `Help.txt` 或联系技术支持。

