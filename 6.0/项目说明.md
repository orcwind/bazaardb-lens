# Bazaar数据库爬虫系统 v6.0 - 项目说明

## 📋 项目概述

本项目是一个完整的网页爬虫系统，用于从 https://bazaardb.gg 网站抓取游戏数据。

**创建日期**: 2025-10-08  
**版本**: 6.0  
**状态**: ✅ 完成

---

## 🎯 解决的问题

### 原有问题
1. ❌ 旧的爬虫代码丢失
2. ❌ 旧的"下载HTML→解析"流程失效
   - Patch 2.0: 图标文件名有意义（如 `Icon_Skill_QuickHeal.webp`）
   - Patch 6.0: 使用hash文件名（如 `a3f2e1b.webp`），无法通过名称匹配
3. ❌ 保存的HTML文件不包含所需信息

### 新方案
✅ 一步到位的爬虫系统
- 直接从网页提取所有信息（不保存中间HTML）
- 自动下载高清图标到本地
- 建立名称→图标的映射关系
- 生成标准化的JSON数据

---

## 📁 项目结构

```
6.0/
├── crawlers/                    # 爬虫脚本
│   ├── __init__.py             # 包初始化
│   ├── utils.py                # 工具函数（日志、图标下载）
│   ├── monster_crawler.py      # 怪物爬虫
│   ├── event_crawler.py        # 事件爬虫
│   └── main.py                 # 主入口程序
│
├── data/                        # 输出的JSON数据
│   ├── monsters.json           # 怪物数据
│   └── events.json             # 事件数据
│
├── icons/                       # 下载的图标
│   ├── skills/                 # 技能图标
│   └── items/                  # 物品/奖励图标
│
├── logs/                        # 日志文件
│   ├── monster_crawler_*.log
│   ├── event_crawler_*.log
│   └── main_*.log
│
├── requirements.txt             # Python依赖
├── README.md                    # 详细文档（英文）
├── 快速开始.txt                 # 快速指南（中文）
├── 项目说明.md                  # 本文件
├── test_crawler.py              # 测试脚本
├── run_crawler.bat              # Windows启动脚本
└── run_crawler.sh               # Linux/Mac启动脚本
```

---

## 🚀 核心功能

### 1. 怪物爬虫 (`monster_crawler.py`)
- 获取所有怪物列表
- 提取每个怪物的：
  - 技能（名称、描述、图标）
  - 物品（名称、描述、图标）
- 自动下载并保存图标
- 生成 `data/monsters.json`

### 2. 事件爬虫 (`event_crawler.py`)
- 获取所有事件列表
- 提取每个事件的：
  - 事件名称和描述
  - 所有选项（名称、描述、图标）
- 自动下载并保存图标
- 生成 `data/events.json`

### 3. 工具模块 (`utils.py`)
- **Logger**: 统一的日志管理
  - 同时输出到控制台和文件
  - 带时间戳的日志文件
- **IconDownloader**: 图标下载器
  - 自动去重（已下载的跳过）
  - 使用文件名hash避免冲突
  - 支持多种图片格式

### 4. 主程序 (`main.py`)
- 命令行参数支持
- 协调多个爬虫运行
- 统一的错误处理

---

## 🛠️ 技术栈

| 技术 | 用途 |
|-----|------|
| Python 3.8+ | 编程语言 |
| Selenium | 浏览器自动化（处理JS渲染） |
| Requests | HTTP请求（下载图标） |
| Chrome/ChromeDriver | 浏览器驱动 |

---

## 📊 数据格式

### monsters.json

```json
{
  "monsters": [
    {
      "name": "怪物名称",
      "skills": [
        {
          "name": "技能名称",
          "icon": "icons/skills/技能名称.webp",
          "description": "技能描述文本",
          "aspect_ratio": 1.0
        }
      ],
      "items": [
        {
          "name": "物品名称",
          "icon": "icons/items/物品名称.webp",
          "description": "物品描述文本",
          "aspect_ratio": 0.5
        }
      ]
    }
  ]
}
```

### events.json

```json
[
  {
    "name": "事件名称",
    "description": "事件类型描述",
    "options": [
      {
        "name": "选项名称",
        "icon": "icons/items/事件名称_选项名称.webp",
        "description": "选项效果描述"
      }
    ]
  }
]
```

---

## 🎨 设计特点

### 1. 模块化设计
- 每个爬虫独立运行
- 共享工具函数
- 易于维护和扩展

### 2. 智能图标管理
- 自动去重（MD5 hash）
- 本地化存储
- 相对路径引用

### 3. 完整的日志系统
- 每次运行独立日志
- 详细的错误信息
- 便于问题排查

### 4. 用户友好
- 多种运行方式
- 清晰的进度提示
- 详细的使用文档

---

## 🚦 使用流程

### 第一次使用

1. **安装依赖**
   ```bash
   cd 6.0
   pip install -r requirements.txt
   ```

2. **测试运行**（推荐）
   ```bash
   python test_crawler.py
   ```
   - 只抓取少量数据
   - 验证爬虫能否正常工作

3. **完整运行**
   ```bash
   cd crawlers
   python main.py
   ```
   - 爬取所有数据
   - 需要1-2小时

### 日常使用

**Windows用户**:
```bash
双击 run_crawler.bat
```

**Linux/Mac用户**:
```bash
bash run_crawler.sh
```

**命令行用户**:
```bash
cd crawlers

# 爬取所有数据
python main.py

# 只爬取怪物
python main.py --type monster

# 只爬取事件  
python main.py --type event

# 后台运行（无头模式）
python main.py --headless
```

---

## ⚙️ 配置选项

### 命令行参数

| 参数 | 选项 | 说明 |
|-----|------|------|
| `--type` | monster, event, all | 爬取类型（默认: all） |
| `--headless` | - | 无头浏览器模式 |

### 可调整的参数

在代码中可以修改：

**延迟时间** (`monster_crawler.py` / `event_crawler.py`)
```python
time.sleep(2)  # 每个请求之间的延迟（秒）
```

**超时时间**
```python
self.driver.set_page_load_timeout(60)  # 页面加载超时（秒）
```

**图标保存目录**
```python
'6.0/icons/skills'  # 技能图标
'6.0/icons/items'   # 物品图标
```

---

## 🔍 工作原理

### 怪物爬虫流程

```
1. 访问 https://bazaardb.gg/search?c=monsters
   ↓
2. 滚动页面，加载所有怪物卡片
   ↓
3. 提取怪物列表（名称、URL）
   ↓
4. 逐个访问怪物详情页
   ↓
5. 在页面中查找：
   - 包含 /skill/ 的图片 → 技能
   - 包含 /item/ 的图片 → 物品
   - 周围的文本 → 名称和描述
   ↓
6. 下载所有图标到本地
   ↓
7. 生成 monsters.json
```

### 事件爬虫流程

```
1. 访问 https://bazaardb.gg/search?c=events
   ↓
2. 滚动页面，加载所有事件卡片
   ↓
3. 提取事件列表（名称、URL）
   ↓
4. 逐个访问事件详情页
   ↓
5. 在页面中查找：
   - 包含 /reward/ 的图片 → 选项
   - 周围的文本 → 选项名称和描述
   ↓
6. 下载所有图标到本地
   ↓
7. 生成 events.json
```

---

## ⚠️ 注意事项

### 1. 法律和道德
- ✅ 遵守网站的使用条款
- ✅ 遵守 robots.txt
- ✅ 合理控制请求频率
- ❌ 不要用于商业用途
- ❌ 不要频繁运行

### 2. 技术要求
- ✅ Chrome浏览器已安装
- ✅ 网络连接稳定
- ✅ 磁盘空间充足（至少500MB）
- ⚠️ 完整爬取需要1-2小时

### 3. 运行时注意
- ✅ 非headless模式会打开浏览器，不要关闭
- ✅ 可以随时按Ctrl+C中断
- ⚠️ 中断后需要重新开始（图标会跳过已下载的）

---

## 🐛 常见问题

### Q: ChromeDriver报错
**A**: Selenium 4.x会自动管理ChromeDriver。如果报错：
1. 检查Chrome浏览器版本
2. 手动下载对应版本的ChromeDriver
3. 添加到系统PATH

### Q: 元素查找失败
**A**: 网站可能更新了HTML结构。需要：
1. 检查网页源代码
2. 更新CSS选择器
3. 修改 `extract_skills()` 和 `extract_items()` 方法

### Q: 图标下载失败
**A**: 可能原因：
- 网络不稳定 → 重试
- URL失效 → 检查日志，手动验证URL
- 服务器限制 → 增加延迟时间

### Q: 数据不完整
**A**: 
1. 查看日志文件了解具体错误
2. 增加页面加载等待时间
3. 检查网络连接
4. 尝试使用非headless模式观察

---

## 📈 未来改进

### 可能的扩展功能
- [ ] 支持增量更新（只抓取新增内容）
- [ ] 添加数据库支持（SQLite）
- [ ] 实现多线程/异步爬取（提高速度）
- [ ] 添加代理支持
- [ ] 实现断点续传
- [ ] 添加GUI界面
- [ ] 支持更多数据类型（装备、符文等）

### 代码优化
- [ ] 更智能的元素定位策略
- [ ] 更完善的错误重试机制
- [ ] 配置文件支持
- [ ] 单元测试

---

## 📝 版本历史

### v6.0 (2025-10-08) - 当前版本
- ✨ 完全重写的爬虫系统
- ✨ 适配Patch 6.0版本网站
- ✨ 直接提取信息，不保存HTML
- ✨ 完整的图标管理系统
- ✨ 模块化架构
- ✨ 详细的文档

### v2.0 (历史版本)
- 基于HTML文件解析
- 依赖有意义的图标文件名
- 两步流程：下载HTML → 解析

---

## 👨‍💻 技术支持

### 文档
- `README.md` - 完整的英文文档
- `快速开始.txt` - 中文快速指南
- `项目说明.md` - 本文件

### 测试
```bash
python test_crawler.py
```

### 日志
查看 `logs/` 目录下的日志文件

---

## 📜 许可证

本项目仅供学习和个人使用。

---

## 🙏 致谢

感谢 bazaardb.gg 提供的游戏数据。

---

**Happy Crawling! 🚀**




