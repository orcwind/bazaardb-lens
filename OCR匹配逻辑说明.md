# OCR匹配逻辑说明

## 一、文本预处理流程

### 1. OCR文本清理
- **输入**：OCR原始文本（如 `'4 血确奇兵 奖励 人 合 ee'`）
- **步骤1**：按行分割文本
- **步骤2**：如果行中包含"奖励"，只保留"奖励"之前的部分
  - 例如：`'4 血确奇兵 奖励 人 合 ee'` → `'4 血确奇兵 '`
- **步骤3**：提取纯中文字符（排除所有数字、字母、标点）
  - 例如：`'4 血确奇兵 '` → `'血确奇兵'`

### 2. 名称候选提取（`extract_name_candidates`）
从清理后的文本中提取可能的名称片段：

**策略**：提取所有2-8个连续中文字符的子串
- 例如：`'血确奇兵'` → 提取候选：`['血确奇兵', '血确奇', '确奇兵', '血确', '确奇', '奇兵', '血', '确', '奇', '兵']`
- **过滤**：排除只包含无关词的候选（如只包含"人"、"全"等）
- **排序**：按长度降序，优先长词
- **限制**：最多返回前10个候选

**无关词列表**：
```python
common_noise_words = {
    '奖励', '人', '全', '合', '使', '倒', '含', '和', '由', '国', '蕊', 
    '本', '上', '站', '机', '作', '区'
}
```

## 二、匹配流程（`find_best_match`）

### 匹配顺序：怪物 → 事件

### 怪物匹配（4种匹配策略，按优先级）

#### **策略1：完全匹配**
- **条件**：OCR纯中文文本 == 怪物名称纯中文文本
- **示例**：`'血礁奇兵'` == `'血礁奇兵'` ✅
- **结果**：立即返回，不继续匹配

#### **策略2：部分匹配（怪物名称在OCR文本中）**
- **条件**：`怪物名称 in OCR文本` 且 `匹配度 > 0.5`
- **匹配度计算**：`len(怪物名称) / len(OCR文本)`
- **示例**：`'血礁奇兵' in '血确奇兵全直及'` → 匹配度 = 4/6 = 0.67 ✅
- **结果**：立即返回

#### **策略3：部分匹配（OCR文本在怪物名称中）**
- **条件**：`OCR文本 in 怪物名称` 且 `匹配度 > 0.5`
- **匹配度计算**：`len(OCR文本) / len(怪物名称)`
- **示例**：`'血确奇' in '血礁奇兵'` → 匹配度 = 3/4 = 0.75 ✅
- **结果**：立即返回

#### **策略4：字符级别匹配**
- **步骤1**：计算字符匹配度
  - 提取怪物名称的所有字符：`{'血', '礁', '奇', '兵'}`
  - 提取OCR文本的所有字符：`{'血', '确', '奇', '兵'}`
  - 计算交集：`{'血', '奇', '兵'}` (3个)
  - 字符匹配度 = `3 / 4 = 0.75`
  
- **步骤2**：根据名称长度判断是否满足字符匹配要求
  - **短名称（2-3字符）**：字符匹配度 ≥ 0.6，至少匹配2个字符
  - **中等名称（4字符）**：字符匹配度 ≥ 0.5，至少匹配2个字符
  - **长名称（5+字符）**：字符匹配度 ≥ 0.4，至少匹配40%的字符
  
- **步骤3**：如果字符匹配通过，计算相似度（SequenceMatcher）
  - 相似度阈值：
    - 长名称（5+字符）：≥ 0.30
    - 其他：≥ 0.35
  - **示例**：`'血确奇兵'` vs `'血礁奇兵'` → 相似度 ≈ 0.75 ✅
- **结果**：如果相似度通过，立即返回

#### **策略5：模糊匹配（SequenceMatcher）**
- **计算**：使用 `difflib.SequenceMatcher` 计算相似度
- **阈值**（根据怪物名称长度动态调整）：
  - **短名称（2-3字符）**：
    - 立即匹配阈值：0.5
    - 候选阈值：0.35
  - **中等名称（4字符）**：
    - 立即匹配阈值：0.40
    - 候选阈值：0.30
  - **长名称（5+字符）**：
    - 立即匹配阈值：0.40
    - 候选阈值：0.30

- **处理**：
  - 如果相似度 > 立即匹配阈值：立即返回
  - 如果相似度 > 候选阈值：加入候选列表，继续匹配其他怪物/事件

### 事件匹配
- 使用类似的匹配策略（完全匹配、部分匹配、字符匹配、模糊匹配）
- 只在怪物匹配失败时进行

### 最终阈值判断
从所有候选匹配中选择最佳匹配：

```python
if best_name:
    name_len = len(clean_text_chinese_only(best_name))
    if name_len <= 3:
        threshold = 0.40  # 短名称
    elif name_len == 4:
        threshold = 0.35  # 中等名称
    else:
        threshold = 0.30  # 长名称
else:
    threshold = 0.35  # 默认

if best_ratio > threshold:
    return (best_type, best_name)
else:
    return (None, None)
```

## 三、匹配示例

### 示例1：`'血确奇兵 奖励 人 合 ee'`
1. **预处理**：`'血确奇兵 奖励 人 合 ee'` → `'血确奇兵'`（排除"奖励"及之后）
2. **提取候选**：`['血确奇兵', '血确奇', '确奇兵', ...]`
3. **匹配怪物"血礁奇兵"**：
   - 完全匹配：`'血确奇兵'` ≠ `'血礁奇兵'` ❌
   - 部分匹配1：`'血礁奇兵' in '血确奇兵'` → False ❌
   - 部分匹配2：`'血确奇兵' in '血礁奇兵'` → False ❌
   - 字符匹配：
     - 字符匹配度：3/4 = 0.75 ✅（满足≥0.5）
     - 相似度：`SequenceMatcher('血确奇兵', '血礁奇兵')` ≈ 0.75
     - 相似度阈值：0.35（4字符名称）
     - 0.75 > 0.35 ✅ → **应该匹配成功**
   - 模糊匹配：相似度 0.75 > 0.40 ✅ → **应该匹配成功**

### 示例2：`'乡巴佬蜥蝎 奖励 SS'`
1. **预处理**：`'乡巴佬蜥蝎 奖励 SS'` → `'乡巴佬蜥蝎'`
2. **提取候选**：`['乡巴佬蜥蝎', '乡巴佬蜥', '巴佬蜥蝎', ...]`
3. **匹配怪物"乡巴佬蜥蜴"**：
   - 完全匹配：`'乡巴佬蜥蝎'` ≠ `'乡巴佬蜥蜴'` ❌
   - 字符匹配：
     - 字符匹配度：5/5 = 1.0 ✅（"蝎"和"蜴"都被识别为相同字符？不对，应该是4/5=0.8）
     - 相似度：`SequenceMatcher('乡巴佬蜥蝎', '乡巴佬蜥蜴')` ≈ 0.8
     - 相似度阈值：0.30（5字符名称）
     - 0.8 > 0.30 ✅ → **应该匹配成功**

## 四、关键配置

### 字符匹配阈值
- 短名称（2-3字符）：字符匹配度 ≥ 0.6
- 中等名称（4字符）：字符匹配度 ≥ 0.5
- 长名称（5+字符）：字符匹配度 ≥ 0.4

### 相似度阈值（模糊匹配）
- 短名称（2-3字符）：立即匹配 ≥ 0.5，候选 ≥ 0.35
- 中等名称（4字符）：立即匹配 ≥ 0.40，候选 ≥ 0.30
- 长名称（5+字符）：立即匹配 ≥ 0.40，候选 ≥ 0.30

### 最终阈值（从候选中选择）
- 短名称（2-3字符）：≥ 0.40
- 中等名称（4字符）：≥ 0.35
- 长名称（5+字符）：≥ 0.30

## 五、当前问题

从日志看，OCR识别出了"血确奇兵"，但没有匹配成功。可能的原因：
1. 提取的候选名称可能不是完整的"血确奇兵"
2. 字符匹配或相似度计算可能有问题
3. 需要查看实际提取的候选名称和匹配过程
